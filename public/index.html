
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Aternos Guard Console</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Sora:wght@400;500;700&display=swap" rel="stylesheet" />
<style>
:root{--bg:#07101b;--bg2:#0c1828;--line:#25435f;--txt:#eef6ff;--muted:#98afc6;--blue:#3bb5f4;--green:#2fd082;--amber:#f1bc67;--red:#ff6472;--mono:"JetBrains Mono",monospace;--font:"Sora",sans-serif}
*{box-sizing:border-box}html,body{margin:0;min-height:100%;font-family:var(--font);color:var(--txt);background:radial-gradient(circle at 8% 0%,rgba(59,181,244,.18),transparent 34%),radial-gradient(circle at 95% 0%,rgba(47,208,130,.14),transparent 30%),linear-gradient(180deg,#081321,#06101a)}
body:before{content:"";position:fixed;inset:0;pointer-events:none;background-image:linear-gradient(rgba(255,255,255,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.03) 1px,transparent 1px);background-size:34px 34px;opacity:.14}
.hidden{display:none!important}.mono{font-family:var(--mono)}
.shell{max-width:1400px;margin:0 auto;padding:18px}.card{border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,rgba(15,30,47,.95),rgba(8,18,30,.95));box-shadow:0 20px 40px rgba(3,10,18,.45)}
.auth{min-height:100vh;display:grid;place-items:center;padding:18px}.auth .box{width:min(460px,100%);padding:24px}.title{margin:0 0 8px;font-size:30px}.sub{margin:0 0 16px;color:var(--muted);line-height:1.6}
.input,.select,.btn{font:inherit}.input,.select{width:100%;padding:11px 12px;border-radius:10px;border:1px solid var(--line);background:#0a1624;color:var(--txt);outline:none}.input:focus,.select:focus{border-color:var(--blue)}
.btn{border:1px solid transparent;border-radius:10px;padding:10px 12px;cursor:pointer;color:#f7fdff;background:#1a334b;font-weight:600}.btn:disabled{opacity:.5;cursor:not-allowed}.btn.primary{background:linear-gradient(180deg,#42c0ff,#1f8fd3)}.btn.good{background:linear-gradient(180deg,#2fda89,#1fa768)}.btn.danger{background:linear-gradient(180deg,#ff6f79,#d83a45)}.btn.ghost{border-color:var(--line);background:rgba(14,27,41,.85)}
.top{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px}.brand{display:flex;gap:10px;align-items:center}.logo{width:36px;height:36px;border-radius:11px;display:grid;place-items:center;background:#16324a;border:1px solid var(--line);color:var(--blue);font-family:var(--mono);font-weight:700}
.pill{border:1px solid var(--line);border-radius:999px;padding:5px 9px;font-size:12px;color:var(--muted);background:#102233}.pill.ok{color:var(--green)}.pill.warn{color:var(--amber)}.pill.bad{color:var(--red)}
.layout{display:grid;grid-template-columns:285px 1fr;gap:14px;margin-top:14px}.side{padding:12px;position:sticky;top:14px;height:fit-content}.tab{width:100%;margin-bottom:8px;text-align:left;border:1px solid #1f334a;background:#0f1f31;color:var(--txt);border-radius:10px;padding:11px;cursor:pointer}.tab.active{border-color:#3bb5f4;background:#143049}
.user{margin-top:12px;padding:10px;border:1px solid #1f334a;border-radius:10px;background:#0d1c2d}.role{display:inline-block;margin:6px 0 8px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:11px;letter-spacing:.08em;font-family:var(--mono);color:var(--blue)}
.page{display:none}.page.active{display:block}.hero{padding:20px;display:flex;justify-content:space-between;gap:10px;align-items:flex-start;margin-bottom:12px}.hero h2{margin:0;font-size:clamp(24px,4vw,40px);line-height:1.08}.hero p{margin:10px 0 0;color:var(--muted);line-height:1.6}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;background:#7f93a7}.dot.online{background:var(--green)}.dot.connecting{background:var(--amber)}.dot.error{background:var(--red)}
.grid{display:grid;gap:12px}.g3{grid-template-columns:repeat(3,minmax(0,1fr))}.g4{grid-template-columns:repeat(4,minmax(0,1fr))}
.panel{padding:14px;border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,rgba(13,25,40,.95),rgba(8,16,27,.93))}
.kpi{border:1px solid #1f334a;border-radius:10px;padding:10px;background:#0d1c2d}.kpi .n{font-size:12px;color:var(--muted);font-family:var(--mono)}.kpi .v{font-size:18px;font-weight:700}
.v.online{color:var(--green)}.v.connecting{color:var(--amber)}.v.error,.v.offline,.v.stopped{color:var(--red)}
.row{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px dashed rgba(37,67,95,.6);color:var(--muted)}.row:last-child{border-bottom:none}.row span:last-child{color:var(--txt);font-family:var(--mono);text-align:right}
.terminal{height:400px;overflow:auto;border-radius:10px;border:1px solid #1f334a;background:#060f1a;padding:11px;font-family:var(--mono);font-size:12px;line-height:1.55}.line{display:grid;grid-template-columns:80px 86px 1fr;gap:8px;margin-bottom:4px}.t{color:#71839a}.lvl{font-weight:700}.INFO{color:#72c6ff}.SUCCESS{color:#34d389}.WARNING{color:#f8c06c}.ERROR{color:#ff6c78}.PING{color:#b6d0ea}.SECURITY{color:#9fddff}
.toolbar{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px}.group{display:flex;gap:8px;flex-wrap:wrap}
.bar{height:10px;border-radius:999px;border:1px solid #1f334a;background:#0d1c2d;overflow:hidden}.fill{height:100%;width:0;transition:width .25s ease;background:linear-gradient(90deg,#2396d7,#45c3ff)}
.bar.good .fill{background:linear-gradient(90deg,#1ca764,#36d78d)}.bar.warn .fill{background:linear-gradient(90deg,#cc8e37,#f4c166)}.bar.bad .fill{background:linear-gradient(90deg,#c23545,#ff6c78)}
.hrow{margin-bottom:12px}.hhead{display:flex;justify-content:space-between;font-size:13px;color:var(--muted);margin-bottom:6px}
table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border-bottom:1px solid rgba(37,64,92,.65);padding:10px 8px;text-align:left;font-size:13px;vertical-align:top}th{color:var(--muted);font-family:var(--mono)}.tinput,.tselect{width:100%;padding:7px 8px;border-radius:8px;border:1px solid #1f334a;background:#0d1c2d;color:var(--txt);font-size:12px}
.toast{position:fixed;right:18px;bottom:18px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1a2a;opacity:0;transform:translateY(8px);transition:.2s;pointer-events:none}.toast.show{opacity:1;transform:translateY(0)}
@media(max-width:1100px){.layout{grid-template-columns:1fr}.side{position:static}.g3,.g4{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media(max-width:760px){.shell{padding:10px}.top{flex-direction:column;align-items:stretch}.hero{flex-direction:column}.g3,.g4{grid-template-columns:1fr}.line{grid-template-columns:68px 72px 1fr;font-size:11px}}
</style>
</head>
<body>
<div id="loginView" class="auth">
  <div class="box card">
    <h1 class="title">Aternos Guard</h1>
    <p class="sub">Sign in with token. Admin = full access. Operator = start and stop only.</p>
    <label class="sub" for="loginToken" style="margin-bottom:6px;display:block">Access Token</label>
    <input id="loginToken" class="input mono" placeholder="admin_xxxxx or usr_xxxxx" autocomplete="off" />
    <div id="loginError" style="display:none;margin-top:8px;color:#ff98a2;font-size:13px;"></div>
    <div style="margin-top:12px"><button id="btnLogin" class="btn primary" style="width:100%">Sign In</button></div>
    <p class="sub" style="margin-top:12px;font-size:13px">If this is first run, the initial admin token appears in server logs.</p>
  </div>
</div>

<div id="appView" class="shell hidden">
  <header class="top card">
    <div class="brand">
      <div class="logo">AG</div>
      <div>
        <div style="font-weight:700">Aternos Guard Console</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:5px">
          <span id="pillRole" class="pill">role</span>
          <span id="pillWs" class="pill">socket</span>
          <span class="pill">role-based control</span>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <span id="topStatus" class="pill">status</span>
      <a class="btn ghost" href="/sidekick.html">Sidekick Add-on</a>
      <a class="btn ghost" href="https://aternos.org/server/" target="_blank" rel="noopener noreferrer">Aternos Panel</a>
    </div>
  </header>

  <div class="layout">
    <aside class="side card">
      <button class="tab active" data-page="dashboard">Dashboard</button>
      <button class="tab" data-page="terminal">Terminal</button>
      <button class="tab" data-page="connection">Connection</button>
      <button class="tab" data-page="health">Health</button>
      <button id="tabTeam" class="tab" data-page="team">Team Access</button>
      <div class="user">
        <div id="userName" style="font-weight:700">-</div>
        <span id="userRole" class="role">-</span>
        <div id="userTokenPreview" class="mono" style="font-size:12px;color:var(--muted);margin-bottom:8px">Token: -</div>
        <button id="btnLogout" class="btn ghost" style="width:100%">Log Out</button>
      </div>
    </aside>

    <main>
      <section id="page-dashboard" class="page active">
        <div class="hero panel">
          <div>
            <h2>Keep your Aternos server awake</h2>
            <p>Invite your team with access roles. Give full admin permissions or only start and stop control.</p>
            <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <span id="statusDot" class="dot"></span>
              <span id="statusText" class="pill">unknown</span>
              <span id="statusHost" class="pill mono">-</span>
            </div>
          </div>
          <div style="display:grid;gap:8px;min-width:145px">
            <button id="btnStart" class="btn primary">Start</button>
            <button id="btnStop" class="btn danger">Stop</button>
            <button id="btnRestart" class="btn ghost">Restart</button>
          </div>
        </div>

        <div class="grid g4" style="margin-bottom:12px">
          <div class="kpi"><div class="n">Bot Status</div><div id="kpiBot" class="v">-</div></div>
          <div class="kpi"><div class="n">Server Status</div><div id="kpiServer" class="v">-</div></div>
          <div class="kpi"><div class="n">Uptime</div><div id="kpiUptime" class="v mono">00:00:00</div></div>
          <div class="kpi"><div class="n">Reconnects</div><div id="kpiReconnects" class="v mono">0</div></div>
        </div>

        <div class="grid g3">
          <div class="panel">
            <h3 style="margin:0 0 10px">Connection</h3>
            <div class="row"><span>Host</span><span id="sumHost">-</span></div>
            <div class="row"><span>Port</span><span id="sumPort">-</span></div>
            <div class="row"><span>Last ping</span><span id="sumPing">-</span></div>
          </div>
          <div class="panel">
            <h3 style="margin:0 0 10px">Identity</h3>
            <div class="row"><span>Username</span><span id="sumUser">-</span></div>
            <div class="row"><span>Version</span><span id="sumVersion">-</span></div>
            <div class="row"><span>Mode</span><span>Offline auth</span></div>
          </div>
          <div class="panel">
            <h3 style="margin:0 0 10px">Quick Actions</h3>
            <div style="display:grid;gap:8px">
              <button id="btnStart2" class="btn good">Start With Config</button>
              <button id="btnRefresh" class="btn ghost">Refresh</button>
              <button id="btnStop2" class="btn danger">Stop Bot</button>
            </div>
          </div>
        </div>
      </section>

      <section id="page-terminal" class="page">
        <div class="panel">
          <div class="toolbar">
            <div>
              <h3 style="margin:0">Live Terminal</h3>
              <div style="font-size:13px;color:var(--muted)">WebSocket logs with auto-reconnect</div>
            </div>
            <div class="group">
              <button id="btnFollow" class="btn ghost">Following</button>
              <button id="btnCopyLogs" class="btn ghost">Copy</button>
              <button id="btnClearLogs" class="btn danger">Clear View</button>
            </div>
          </div>
          <div id="terminal" class="terminal"></div>
        </div>
      </section>
      <section id="page-connection" class="page">
        <div class="panel">
          <h3 style="margin-top:0">Connection Settings</h3>
          <div style="font-size:13px;color:var(--muted);margin-bottom:10px">Only admin can save connection changes.</div>
          <div class="grid g3">
            <div><div style="font-size:12px;color:var(--muted);margin-bottom:6px">Host</div><input id="cfgHost" class="input mono" /></div>
            <div><div style="font-size:12px;color:var(--muted);margin-bottom:6px">Port</div><input id="cfgPort" class="input mono" /></div>
            <div><div style="font-size:12px;color:var(--muted);margin-bottom:6px">Username</div><input id="cfgUsername" class="input mono" /></div>
            <div><div style="font-size:12px;color:var(--muted);margin-bottom:6px">Version</div><input id="cfgVersion" class="input mono" /></div>
            <div><div style="font-size:12px;color:var(--muted);margin-bottom:6px">Reconnect (ms)</div><input id="cfgReconnect" class="input mono" /></div>
            <div><div style="font-size:12px;color:var(--muted);margin-bottom:6px">Ping Interval (ms)</div><input id="cfgPing" class="input mono" /></div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnSaveConfig" class="btn primary">Save Config</button>
            <button id="btnSaveRestart" class="btn good">Save and Restart</button>
          </div>
        </div>
      </section>

      <section id="page-team" class="page">
        <div class="panel">
          <h3 style="margin-top:0">Team Access Control</h3>
          <div style="font-size:13px;color:var(--muted);margin-bottom:10px">admin = full access, operator = start and stop only, viewer = read-only.</div>
          <div id="teamDisabled" class="hidden" style="font-size:13px;color:var(--red);margin-bottom:10px">You do not have permission to manage users.</div>
          <div id="createMemberCard" class="grid g3">
            <div><div style="font-size:12px;color:var(--muted);margin-bottom:6px">Member Name</div><input id="memberName" class="input" /></div>
            <div><div style="font-size:12px;color:var(--muted);margin-bottom:6px">Role</div><select id="memberRole" class="select"><option value="operator">operator</option><option value="viewer">viewer</option><option value="admin">admin</option></select></div>
            <div><div style="font-size:12px;color:var(--muted);margin-bottom:6px">Custom Token (optional)</div><input id="memberToken" class="input mono" /></div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnCreateMember" class="btn primary">Create Member</button>
            <button id="btnReloadUsers" class="btn ghost">Reload Users</button>
          </div>
          <div id="createdToken" class="mono" style="display:none;margin-top:10px;padding:9px;border:1px dashed rgba(59,181,244,.5);border-radius:8px;background:rgba(14,42,65,.45);font-size:12px"></div>
          <table>
            <thead><tr><th>Name</th><th>Role</th><th>Token</th><th>Last Login</th><th>Actions</th></tr></thead>
            <tbody id="usersBody"></tbody>
          </table>
        </div>
      </section>

      <section id="page-health" class="page">
        <div class="panel">
          <h3 style="margin-top:0">Health Monitor</h3>
          <div class="hrow"><div class="hhead"><span>Bot Online Score</span><span id="healthBotPct">0%</span></div><div id="barBot" class="bar"><span id="fillBot" class="fill"></span></div></div>
          <div class="hrow"><div class="hhead"><span>Server Reachability</span><span id="healthServerPct">0%</span></div><div id="barServer" class="bar"><span id="fillServer" class="fill"></span></div></div>
          <div class="hrow"><div class="hhead"><span>Stability</span><span id="healthStabilityPct">0%</span></div><div id="barStability" class="bar"><span id="fillStability" class="fill"></span></div></div>
          <div class="grid g4" style="margin-top:10px">
            <div class="kpi"><div class="n">Last Event</div><div id="healthEvent" class="v mono" style="font-size:13px">-</div></div>
            <div class="kpi"><div class="n">Reconnect Delay</div><div id="healthDelay" class="v mono" style="font-size:13px">-</div></div>
            <div class="kpi"><div class="n">Ping Interval</div><div id="healthPing" class="v mono" style="font-size:13px">-</div></div>
            <div class="kpi"><div class="n">Running</div><div id="healthRunning" class="v" style="font-size:13px">-</div></div>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>
<div id="toast" class="toast"></div>

<script>
const auth={sessionToken:localStorage.getItem("ag_session")||"",user:null,permissions:[]};
const state={botStatus:"stopped",serverStatus:"unknown",reconnectAttempts:0,lastPing:null,lastEventAt:null,uptime:0,isRunning:false,config:{host:"-",port:"-",username:"-",reconnectDelay:0,pingInterval:0,version:"-"}};
const rt={ws:null,wsRetry:null,logs:[],follow:true,users:[],statusPoll:null,uptimeTick:null};
const PAGES=["dashboard","terminal","connection","team","health"];
const $=id=>document.getElementById(id);
const esc=s=>String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;");
const fmtTime=iso=>{if(!iso)return"-";const d=new Date(iso);return isNaN(d.getTime())?"-":d.toLocaleTimeString()};
const fmtUp=ms=>{const t=Math.max(0,Math.floor(ms/1000));const h=String(Math.floor(t/3600)).padStart(2,"0");const m=String(Math.floor((t%3600)/60)).padStart(2,"0");const s=String(t%60).padStart(2,"0");return `${h}:${m}:${s}`};
const statusCls=s=>s==="online"?"online":s==="connecting"?"connecting":(s==="error"||s==="offline"||s==="stopped")?"error":"";
const tone=s=>s==="online"?"ok":s==="connecting"?"warn":(s==="error"||s==="offline"||s==="stopped")?"bad":"";
const has=p=>auth.permissions.includes(p);
function note(msg){const t=$("toast");t.textContent=msg;t.classList.add("show");clearTimeout(t._tm);t._tm=setTimeout(()=>t.classList.remove("show"),2600)}
function setLoginError(msg){const e=$("loginError");if(!e)return;if(msg){e.textContent=msg;e.style.display="block"}else{e.style.display="none";e.textContent=""}}
function setSession(t){auth.sessionToken=t;localStorage.setItem("ag_session",t)}
function clearSession(){auth.sessionToken="";auth.user=null;auth.permissions=[];localStorage.removeItem("ag_session")}
function showLogin(){$("loginView").classList.remove("hidden");$("appView").classList.add("hidden")}
function showApp(){setLoginError("");$("loginView").classList.add("hidden");$("appView").classList.remove("hidden")}
function wsLabel(ok){const e=$("pillWs");e.textContent=ok?"socket live":"socket reconnect";e.className=`pill ${ok?"ok":"warn"}`}
async function api(path,opt={}){const h={};if(auth.sessionToken)h.Authorization=`Bearer ${auth.sessionToken}`;if(opt.body!==undefined)h["Content-Type"]="application/json";const r=await fetch(path,{method:opt.method||"GET",headers:h,body:opt.body!==undefined?JSON.stringify(opt.body):undefined});let d={};try{d=await r.json()}catch{}if(!r.ok){if(r.status===401)unauth("Please sign in again");throw new Error(d.message||`${r.status} ${r.statusText}`)}return d}
function unauth(msg){closeSocket();clearSession();showLogin();note(msg||"Session expired")}
function authApply(user,permissions){auth.user=user;auth.permissions=permissions||[];$("userName").textContent=user?.name||"-";$("userRole").textContent=(user?.role||"-").toUpperCase();$("userTokenPreview").textContent=`Token: ${user?.tokenPreview||"-"}`;$("pillRole").textContent=(user?.role||"-").toUpperCase();gate()}
function gate(){const c=has("bot:control"),w=has("config:write"),ur=has("users:read"),uw=has("users:write");["btnStart","btnStop","btnRestart","btnStart2","btnStop2"].forEach(id=>$(id).disabled=!c);["cfgHost","cfgPort","cfgUsername","cfgVersion","cfgReconnect","cfgPing"].forEach(id=>$(id).disabled=!w);$("btnSaveConfig").disabled=!w;$("btnSaveRestart").disabled=!(w&&c);$("tabTeam").classList.toggle("hidden",!ur);$("teamDisabled").classList.toggle("hidden",uw);$("createMemberCard").classList.toggle("hidden",!uw);$("btnCreateMember").disabled=!uw}
function setPage(p){PAGES.forEach(n=>$(`page-${n}`).classList.toggle("active",n===p));document.querySelectorAll(".tab").forEach(b=>b.classList.toggle("active",b.dataset.page===p));if(p==="team"&&has("users:read"))loadUsers();if(p==="connection")loadConfigForm()}
function applyState(part){if(part.config)state.config={...state.config,...part.config};["botStatus","serverStatus","reconnectAttempts","lastPing","lastEventAt","uptime","isRunning"].forEach(k=>{if(part[k]!==undefined)state[k]=part[k]});renderDash();renderHealth()}
function renderDash(){$("statusDot").className=`dot ${statusCls(state.botStatus)}`;$("topStatus").textContent=`${state.botStatus} / ${state.serverStatus}`;$("topStatus").className=`pill ${tone(state.botStatus)}`;$("statusText").textContent=state.botStatus;$("statusHost").textContent=`${state.config.host}:${state.config.port}`;$("kpiBot").textContent=state.botStatus;$("kpiBot").className=`v ${statusCls(state.botStatus)}`;$("kpiServer").textContent=state.serverStatus;$("kpiServer").className=`v ${statusCls(state.serverStatus)}`;$("kpiUptime").textContent=fmtUp(state.uptime||0);$("kpiReconnects").textContent=String(state.reconnectAttempts||0);$("sumHost").textContent=state.config.host||"-";$("sumPort").textContent=String(state.config.port||"-");$("sumPing").textContent=fmtTime(state.lastPing);$("sumUser").textContent=state.config.username||"-";$("sumVersion").textContent=state.config.version||"-";if(has("bot:control")){$("btnStart").disabled=state.isRunning;$("btnStart2").disabled=state.isRunning;$("btnStop").disabled=!state.isRunning;$("btnStop2").disabled=!state.isRunning;$("btnRestart").disabled=!state.isRunning}}
function setBar(barId,fillId,pctId,v){const b=$(barId),p=Math.max(0,Math.min(100,Math.round(v)));b.classList.remove("good","warn","bad");if(p>=70)b.classList.add("good");else if(p>=40)b.classList.add("warn");else b.classList.add("bad");$(fillId).style.width=`${p}%`;$(pctId).textContent=`${p}%`}
function renderHealth(){const b=state.botStatus==="online"?100:state.botStatus==="connecting"?58:10;const s=state.serverStatus==="online"?100:state.serverStatus==="offline"?18:35;const st=Math.max(0,100-(state.reconnectAttempts||0)*8);setBar("barBot","fillBot","healthBotPct",b);setBar("barServer","fillServer","healthServerPct",s);setBar("barStability","fillStability","healthStabilityPct",st);$("healthEvent").textContent=fmtTime(state.lastEventAt);$("healthDelay").textContent=`${state.config.reconnectDelay||0} ms`;$("healthPing").textContent=`${state.config.pingInterval||0} ms`;$("healthRunning").textContent=state.isRunning?"YES":"NO";$("healthRunning").className=`v ${state.isRunning?"online":"error"}`}
function addLog(e){rt.logs.push(e);if(rt.logs.length>500)rt.logs.shift();const t=$("terminal"),l=document.createElement("div");l.className="line";l.innerHTML=`<span class="t">${esc(fmtTime(e.time))}</span><span class="lvl ${esc(e.level)}">${esc(e.level)}</span><span>${esc(e.message)}</span>`;t.appendChild(l);if(t.children.length>600)t.removeChild(t.firstChild);if(rt.follow)t.scrollTop=t.scrollHeight}
function drawLogs(){$("terminal").innerHTML="";const copy=[...rt.logs];rt.logs=[];copy.forEach(addLog)}
function closeSocket(){if(rt.wsRetry){clearTimeout(rt.wsRetry);rt.wsRetry=null}if(rt.ws){rt.ws.onclose=null;rt.ws.close();rt.ws=null}wsLabel(false)}
function connectSocket(){closeSocket();if(!auth.sessionToken)return;const proto=location.protocol==="https:"?"wss":"ws";rt.ws=new WebSocket(`${proto}://${location.host}?session=${encodeURIComponent(auth.sessionToken)}`);rt.ws.onopen=()=>wsLabel(true);rt.ws.onmessage=ev=>{let m;try{m=JSON.parse(ev.data)}catch{return}if(m.type==="init"){rt.logs=Array.isArray(m.data.logs)?m.data.logs.slice(-500):[];const p={...m.data};delete p.logs;applyState(p);drawLogs();if(m.data.user&&m.data.permissions)authApply(m.data.user,m.data.permissions)}if(m.type==="status")applyState(m.data||{});if(m.type==="log")addLog(m.data);if(m.type==="error")note(m.data?.message||"Socket error")};rt.ws.onclose=e=>{wsLabel(false);if(e.code===4001){unauth("Session expired");return}if(!auth.sessionToken)return;rt.wsRetry=setTimeout(connectSocket,2000)}}
async function login(){const token=$("loginToken").value.trim();const b=$("btnLogin");setLoginError("");if(!token){setLoginError("اكتب التوكن أول.");note("Enter token first");return}const old=b.textContent;b.disabled=true;b.textContent="Signing in...";try{const r=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token})});const p=await r.json();if(!r.ok||!p.success)throw new Error(p.message||"Login failed");setSession(p.sessionToken);authApply(p.user,p.permissions);showApp();await refreshStatus();connectSocket();if(has("users:read"))loadUsers();note(`Welcome ${p.user.name}`)}catch(e){const m=e.message||"Login failed";setLoginError(`فشل تسجيل الدخول: ${m}`);note(m)}finally{b.disabled=false;b.textContent=old}}
async function logout(){try{if(auth.sessionToken)await api("/api/auth/logout",{method:"POST"})}catch{}closeSocket();clearSession();showLogin();note("Logged out")}
async function refreshStatus(){const p=await api("/api/status");applyState(p)}
async function runAction(a){if(!has("bot:control")){note("No bot control permission");return}try{const r=await api(`/api/${a}`,{method:"POST"});if(!r.success)note(r.message||`Cannot ${a}`);else note(`${a} command sent`)}catch(e){note(e.message||`Failed to ${a}`)}}
async function loadConfigForm(){if(!has("config:read"))return;try{const c=await api("/api/config");$("cfgHost").value=c.host||"";$("cfgPort").value=c.port||"";$("cfgUsername").value=c.username||"";$("cfgVersion").value=c.version||"";$("cfgReconnect").value=c.reconnectDelay||"";$("cfgPing").value=c.pingInterval||""}catch(e){note(e.message||"Failed loading config")}}
async function saveConfig(restart){if(!has("config:write")){note("Only admin can edit config");return}const body={host:$("cfgHost").value,port:$("cfgPort").value,username:$("cfgUsername").value,version:$("cfgVersion").value,reconnectDelay:$("cfgReconnect").value,pingInterval:$("cfgPing").value};try{await api("/api/config",{method:"POST",body});note("Config saved");await refreshStatus();if(restart)await runAction("restart")}catch(e){note(e.message||"Failed saving config")}}
function renderUsers(){const b=$("usersBody");if(!rt.users.length){b.innerHTML='<tr><td colspan="5" style="color:var(--muted)">No members yet.</td></tr>';return}const can=has("users:write");b.innerHTML=rt.users.map(u=>`<tr data-user-id="${esc(u.id)}"><td><input class="tinput member-name" value="${esc(u.name)}" ${can?"":"disabled"}/></td><td><select class="tselect member-role" ${can?"":"disabled"}><option value="admin" ${u.role==="admin"?"selected":""}>admin</option><option value="operator" ${u.role==="operator"?"selected":""}>operator</option><option value="viewer" ${u.role==="viewer"?"selected":""}>viewer</option></select></td><td class="mono">${esc(u.tokenPreview||"-")}</td><td class="mono">${esc(fmtTime(u.lastLoginAt))}</td><td>${can?'<div style="display:flex;gap:6px;flex-wrap:wrap"><button class="btn ghost" data-action="save">Save</button><button class="btn ghost" data-action="rotate">Rotate Token</button><button class="btn danger" data-action="delete">Delete</button></div>':'-'}</td></tr>`).join("")}
async function loadUsers(){if(!has("users:read"))return;try{const p=await api("/api/users");rt.users=Array.isArray(p.users)?p.users:[];renderUsers()}catch(e){note(e.message||"Failed loading users")}}
async function createMember(){if(!has("users:write")){note("No users:write permission");return}const name=$("memberName").value.trim(),role=$("memberRole").value,token=$("memberToken").value.trim();if(!name){note("Member name is required");return}try{const p=await api("/api/users",{method:"POST",body:{name,role,token:token||undefined}});$("memberName").value="";$("memberToken").value="";const box=$("createdToken");box.style.display="block";box.textContent=`Created token (${p.user.name}): ${p.user.token}`;note("Member created");await loadUsers()}catch(e){note(e.message||"Failed creating member")}}
async function userAction(ev){const btn=ev.target.closest("button[data-action]");if(!btn)return;const row=btn.closest("tr[data-user-id]");if(!row)return;if(!has("users:write")){note("No users:write permission");return}const id=row.dataset.userId,act=btn.dataset.action;try{if(act==="save"){const name=row.querySelector(".member-name").value.trim();const role=row.querySelector(".member-role").value;const p=await api(`/api/users/${encodeURIComponent(id)}`,{method:"PATCH",body:{name,role}});note(`Saved ${p.user.name}`)}if(act==="rotate"){const p=await api(`/api/users/${encodeURIComponent(id)}`,{method:"PATCH",body:{rotateToken:true}});const box=$("createdToken");box.style.display="block";box.textContent=`New token (${p.user.name}): ${p.user.token}`;note(`Rotated token for ${p.user.name}`)}if(act==="delete"){if(!confirm("Delete this user?"))return;await api(`/api/users/${encodeURIComponent(id)}`,{method:"DELETE"});note("User deleted")}await loadUsers()}catch(e){note(e.message||"User update failed")}}
function bindTabs(){document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click",()=>{const p=t.dataset.page;if(p==="team"&&!has("users:read")){note("No team access permission");return}setPage(p)}))}
async function restore(){if(!auth.sessionToken){showLogin();return}try{const p=await api("/api/me");authApply(p.user,p.permissions);showApp();await refreshStatus();connectSocket();if(has("users:read"))await loadUsers()}catch{showLogin()}}
function timers(){if(!rt.statusPoll)rt.statusPoll=setInterval(()=>{if(!auth.sessionToken)return;refreshStatus().catch(()=>{})},12000);if(!rt.uptimeTick)rt.uptimeTick=setInterval(()=>{if(state.isRunning&&state.botStatus==="online"){state.uptime+=1000;$("kpiUptime").textContent=fmtUp(state.uptime||0)}},1000)}
function bind(){$("btnLogin").addEventListener("click",login);$("loginToken").addEventListener("keydown",e=>{if(e.key==="Enter")login()});$("btnLogout").addEventListener("click",logout);$("btnStart").addEventListener("click",()=>runAction("start"));$("btnStart2").addEventListener("click",()=>runAction("start"));$("btnStop").addEventListener("click",()=>runAction("stop"));$("btnStop2").addEventListener("click",()=>runAction("stop"));$("btnRestart").addEventListener("click",()=>runAction("restart"));$("btnRefresh").addEventListener("click",()=>refreshStatus().catch(e=>note(e.message)));$("btnSaveConfig").addEventListener("click",()=>saveConfig(false));$("btnSaveRestart").addEventListener("click",()=>saveConfig(true));$("btnCreateMember").addEventListener("click",createMember);$("btnReloadUsers").addEventListener("click",loadUsers);$("usersBody").addEventListener("click",userAction);$("btnClearLogs").addEventListener("click",()=>{$("terminal").innerHTML=""});$("btnCopyLogs").addEventListener("click",async()=>{const txt=rt.logs.map(e=>`[${fmtTime(e.time)}] [${e.level}] ${e.message}`).join("\n");try{await navigator.clipboard.writeText(txt);note("Logs copied")}catch{note("Clipboard blocked")}});$("btnFollow").addEventListener("click",()=>{rt.follow=!rt.follow;$("btnFollow").textContent=rt.follow?"Following":"Paused"});bindTabs()}
function boot(){wsLabel(false);bind();timers();restore()}
boot();
</script>
</body>
</html>
